function waymark_setup_map_export(){jQuery(".waymark-map-export, .waymark-collection-export").each((function(){var a=jQuery(this);if(a){var e=a.parents(".waymark-shortcode");if(e.length)var r=jQuery(".waymark-map",e);else r=jQuery(".waymark-map");var t=a.parents(".waymark-meta-export_data");if(t.length||(t=a.parent("div")),"FORM"!=a.get(0).tagName){for(var o=jQuery("<form>").append(a.contents()),n=a.get(0).attributes,i=n.length-1;i>=0;i--)o.attr(n[i].name,n[i].value);a.replaceWith(o),a=o}var u=jQuery('input[name="map_data"]',a),y=r.data("Waymark");void 0!==y&&y.map.on("layerremove layeradd",(function(){var a=0;y.map_data.eachLayer((function(e){y.map.hasLayer(e)&&a++})),a>0?t.show():t.hide()})),a.on("submit",(function(e){var t=jQuery("select",a),o=t.val()?t.val():"geojson",n=Waymark_L.layerGroup();(y=r.data("Waymark")).map_data.eachLayer((function(a){for(key in a.feature.properties)if(void 0!==a.feature.properties[key]?"title"==key&&"kml"==o&&(a.feature.properties.name=a.feature.properties[key],delete a.feature.properties[key]):delete a.feature.properties[key],"description"==key&&void 0!==a.feature.properties.description){var e=a.feature.properties.description,r=e.indexOf('<div class="waymark-description-link');-1!==r&&(e=e.substring(0,r)),e=e.replace("'","&apos;"),a.feature.properties.description=e}n.addLayer(a)}));var i=n.toGeoJSON();switch(t.val()){case"gpx":const e={metadata:{}};var s=jQuery('input[name="map_title"]',a).val();s&&(e.metadata.name=s);var c=togpx(i,e);break;case"kml":c=tokml(i);break;default:case"geojson":c=JSON.stringify(i)}u.val(encodeURIComponent(c))}))}}))}function waymark_setup_parameter_tooltips(){jQuery("a.waymark-tooltip").on({mouseenter:function(a){var e=jQuery(this).data("title");jQuery('<p id="waymark-tooltip-active"></p>').text(e).appendTo("body").fadeIn("slow")},mouseleave:function(a){jQuery("#waymark-tooltip-active").remove()},mousemove:function(a){if(waymark_is_touch_device())var e=a.pageX-250;else e=a.pageX-220;var r=a.pageY+5;jQuery("#waymark-tooltip-active").css({top:r,left:e})}})}function waymark_is_touch_device(){var a=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(a){return window.matchMedia(a).matches}(["(",a.join("touch-enabled),("),"heartz",")"].join(""))}function waymark_setup_accordions(){var a=jQuery(".waymark-accordion-container");a.length&&(a.addClass("waymark-self-clear"),a.each((function(){var a=0;jQuery(".waymark-accordion-group",jQuery(this)).each((function(){jQuery(this).addClass("waymark-self-clear"),jQuery(this).data("waymark-index",a);var e=jQuery(".waymark-accordion-group-content",jQuery(this));0==a?(jQuery(this).addClass("waymark-first"),e.show().addClass(a)):e.hide().addClass(a),jQuery("legend",jQuery(this)).each((function(){var a=jQuery(this).html();-1==a.indexOf("[+]")&&jQuery(this).html(a+" <span>[+]</span>"),jQuery(this).click((function(){var a=jQuery(this).parents(".waymark-accordion-group").data("waymark-index");jQuery(".waymark-accordion-group",jQuery(this).parents(".waymark-accordion-container")).each((function(){jQuery(this).data("waymark-index")==a?jQuery(".waymark-accordion-group-content",jQuery(this)).slideDown():jQuery(".waymark-accordion-group-content",jQuery(this)).slideUp()}))}))})),a++}))})))}function waymark_setup_map_editor(a={}){if(!a.map)return void a.message("waymark_editor.map not available","error");jQuery(".waymark-edit-toolbar a.waymark-edit-upload").removeClass("waymark-hidden");const e=jQuery(".waymark-edit-toolbar a.waymark-edit-image");e.length&&(a.debug("Enabling Front-End Image Uploads."),e.removeClass("waymark-hidden"),e.on("click",(function(e){e.preventDefault();var r=jQuery("<input />").attr({type:"file",name:"add_photo"}).css("display","none").change((function(){a.handle_file_upload(jQuery(this))}));return jQuery("#waymark-edit-toolbar").append(r),r.trigger("click"),!1}))),a.map.on("popupopen",(function(e){const r=e.popup._source.feature,t=jQuery(".waymark-map .waymark-info").first(),o=jQuery(".waymark-info-image_large_url .button",t);o.length&&(o.removeClass("waymark-hidden"),o.on("click",(function(e){e.preventDefault();var o=jQuery("<input />").attr({type:"file",name:"marker_photo"}).css("display","none").change((function(){a.handle_file_upload(jQuery(this),{feature:r,img_view:jQuery(".waymark-info-image_large_url a",t),img_input:jQuery(".waymark-info-image_large_url input",t)})}));return t.append(o),o.trigger("click"),!1})))}))}function waymark_setup_map_shortcode(){jQuery(".waymark-shortcode").each((function(){var a=jQuery(this);jQuery(".waymark-header",a).each((function(){var e=jQuery(this),r=jQuery(".waymark-link",e).first(),t=jQuery(".waymark-meta",e);if(t.length){var o=jQuery(".waymark-map-export",t).length,n=jQuery(".waymark-meta-item",t);o&&n.length;r.on("click",(function(){return t.show(),!1})),jQuery("i",r).attr("class","ion ion-map"),t.css("height",a.height()+"px");var i=jQuery("<i />").attr({class:"waymark-meta-close ion ion-close"}).on("click",(function(){t.hide()}));t.append(i)}}))}))}jQuery(document).ready((function(){waymark_setup_parameter_tooltips(),waymark_setup_map_export(),waymark_setup_accordions()})),jQuery(document).ready((function(){waymark_setup_map_shortcode()}));