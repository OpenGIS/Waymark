function waymark_setup_map_export(){jQuery(".waymark-map-export").each((function(){var a=jQuery(this);if(a){var e=a.parents(".waymark-shortcode");if(e.length)var r=jQuery(".waymark-map",e);else r=jQuery(".waymark-map");var t=a.parents(".waymark-meta-export_data");if(t.length||(t=a.parent("div")),"FORM"!=a.get(0).tagName){for(var n=jQuery("<form>").append(a.contents()),i=a.get(0).attributes,s=i.length-1;s>=0;s--)n.attr(i[s].name,i[s].value);a.replaceWith(n),a=n}var u=jQuery('input[name="map_data"]',a),o=r.data("Waymark");void 0!==o&&o.map.on("layerremove layeradd",(function(){var a=0;o.map_data.eachLayer((function(e){o.map.hasLayer(e)&&a++})),a>0?t.show():t.hide()})),a.on("submit",(function(e){var t=jQuery("select",a),n=t.val()?t.val():"geojson",i=Waymark_L.layerGroup();(o=r.data("Waymark")).map_data.eachLayer((function(a){if(o.map.hasLayer(a)){for(key in a.feature.properties)void 0!==a.feature.properties[key]?"title"==key&&"kml"==n&&(a.feature.properties.name=a.feature.properties[key],delete a.feature.properties[key]):delete a.feature.properties[key];i.addLayer(a)}}));var s=i.toGeoJSON();switch(t.val()){case"gpx":var y=togpx(s);break;case"kml":y=tokml(s);break;default:case"geojson":y=JSON.stringify(s)}u.val(encodeURIComponent(y))}))}}))}function waymark_setup_parameter_tooltips(){jQuery("a.waymark-tooltip").on({mouseenter:function(a){var e=jQuery(this).data("title");jQuery('<p id="waymark-tooltip-active"></p>').text(e).appendTo("body").fadeIn("slow")},mouseleave:function(a){jQuery("#waymark-tooltip-active").remove()},mousemove:function(a){if(waymark_is_touch_device())var e=a.pageX-250;else e=a.pageX-220;var r=a.pageY+5;jQuery("#waymark-tooltip-active").css({top:r,left:e})}})}function waymark_is_touch_device(){var a=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(a){return window.matchMedia(a).matches}(["(",a.join("touch-enabled),("),"heartz",")"].join(""))}function waymark_setup_accordions(){var a=jQuery(".waymark-accordion-container");a.length&&(a.addClass("waymark-self-clear"),a.each((function(){var a=0;jQuery(".waymark-accordion-group",jQuery(this)).each((function(){jQuery(this).addClass("waymark-self-clear"),jQuery(this).data("waymark-index",a);var e=jQuery(".waymark-accordion-group-content",jQuery(this));0==a?(jQuery(this).addClass("waymark-first"),e.show().addClass(a)):e.hide().addClass(a),jQuery("legend",jQuery(this)).each((function(){var a=jQuery(this).html();-1==a.indexOf("[+]")&&jQuery(this).html(a+" <span>[+]</span>"),jQuery(this).click((function(){var a=jQuery(this).parents(".waymark-accordion-group").data("waymark-index");jQuery(".waymark-accordion-group",jQuery(this).parents(".waymark-accordion-container")).each((function(){jQuery(this).data("waymark-index")==a?jQuery(".waymark-accordion-group-content",jQuery(this)).slideDown():jQuery(".waymark-accordion-group-content",jQuery(this)).slideUp()}))}))})),a++}))})))}function waymark_setup_colour_pickers(){jQuery(".waymark-colour-picker .waymark-input").wpColorPicker()}function waymark_setup_repeatable_settings(){jQuery(".waymark-settings-tab .waymark-repeatable").each((function(){var a=jQuery(this);jQuery(".form-table",a).each((function(){var e=jQuery(this),r=[];for(e.remove(),jQuery(".waymark-input",e).each((function(){var a=jQuery(this);if(a.addClass("waymark-"+a.data("id")),"SELECT"!=a.get(0).nodeName)var e=a.val();else e=a.data("multi-value");for(i in"string"!=typeof e&&(e=e.toString()),e=e.split(waymark_multi_value_seperator))"object"!=typeof r[i]&&(r[i]={}),r[i][a.data("id")]=e[i]})),i=0;i<r.length;i++){var t=e.clone();for(j in r[i]){var n=r[i][j],s=jQuery(".waymark-input-"+j,t);s.attr("name",s.attr("name")+"["+i+"]"),"SELECT"!=s.get(0).nodeName||jQuery("option[value='"+r[i][j]+"']",s).length||(n=jQuery("option",s).first().val()),s.attr("value",n).val(n),s.parents(".waymark-control-group").hasClass("waymark-uneditable")&&s.attr("readonly","readonly")}var u=jQuery("<div />").text("x").attr("title",waymark_admin_js.lang.repeatable_delete_title).addClass("waymark-delete").on("click",(function(a){return a.preventDefault(),jQuery(this).parents(".form-table").remove(),!1}));t.append(u),a.append(t),a.attr("data-count",i),waymark_setup_parameter_tooltips()}var o=jQuery("<button />").html('<i class="ion ion-plus"></i>').addClass("button waymark-add").on("click",(function(a){a.preventDefault();var r=jQuery(this).parents(".waymark-repeatable"),t=parseInt(r.attr("data-count"))+1;r.attr("data-count",t);var n=e.clone();return jQuery(".waymark-input",n).each((function(){var a=jQuery(this),e=a.attr("name")+"["+t+"]";switch(a.attr("name",e),a.attr("placeholder",""),"SELECT"!=a.get(0).nodeName&&a.val(""),a.data("id")){case"line_colour":case"shape_colour":case"icon_colour":case"marker_colour":a.wpColorPicker();break;case"meta_options":a.parents("tr").hide()}})),jQuery(this).before(n),waymark_setup_parameter_tooltips(),waymark_setup_select_meta_type(),waymark_setup_select_icon_type(),!1}));a.append(o),a.sortable()}))}))}function waymark_setup_repeatable_forms(){jQuery(".waymark-form.waymark-repeatable").each((function(){}))}function waymark_setup_marker_tab(){jQuery(".waymark-input.waymark-marker_icon").each((function(){var a=jQuery(this),e="";0===a.val().indexOf("ion-")?e+="ion "+a.val():0===a.val().indexOf("fa-")?e+="fa "+a.val():e+="ion ion-"+a.val();var r=jQuery("<i />").addClass(e);a.parents(".waymark-controls").prepend(r)}));var a=jQuery(".waymark-input.waymark-marker_colour");if("function"==typeof Waymark_Map){var e=new Waymark_Map;a.each((function(){jQuery(this).val(e.get_marker_background(jQuery(this).val())),jQuery(this).wpColorPicker()}))}}function waymark_setup_external_links(){jQuery(".waymark-settings-tab a,#waymark_map_meta a").each((function(){location.hostname!==this.hostname&&this.hostname.length&&void 0===jQuery(this).attr("target")&&jQuery(this).attr("target","_blank")}))}function waymark_setup_select_meta_type(){jQuery("select.waymark-meta_type").each((function(){var a=jQuery(this),e=a.parents(".form-table"),r=jQuery(".waymark-input.waymark-meta_options",e).parents("tr");"select"==a.val()||"select_multi"==a.val()?r.show():r.hide(),a.change((function(){"select"==a.val()||"select_multi"==a.val()?r.show():r.hide()}))}))}function waymark_setup_select_icon_type(){jQuery("select.waymark-icon_type").each((function(){var a=jQuery(this),e=a.parents(".form-table"),r=jQuery(".waymark-input.waymark-icon_colour",e).parents("tr"),t=jQuery(".waymark-input.waymark-marker_icon",e),n=t.parents("tr"),i=jQuery(".waymark-icon-type",n),s=jQuery(".waymark-controls i",n),u=jQuery(".waymark-icons-help",n),o=jQuery(".waymark-tooltip",n),y=o.attr("data-title").split("|"),m=function(a){switch(a){case"icon":s.show(),u.show(),r.show(),t.css("maxWidth","unset"),i.text(waymark_admin_js.lang.marker_icon_icon_label),o.data("title",y[0]);break;case"text":s.hide(),u.hide(),r.show(),t.css("maxWidth","45px"),i.text(waymark_admin_js.lang.marker_icon_text_label),o.data("title",y[1]);break;case"html":s.hide(),u.hide(),r.hide(),t.css("maxWidth","unset"),i.text(waymark_admin_js.lang.marker_icon_html_label),o.data("title",y[2])}waymark_setup_parameter_tooltips()};m(a.val()),a.change((function(){m(a.val())}))}))}function waymark_setup_dropdowns(){jQuery(".waymark-parameters-container").each((function(){var a=jQuery(this);jQuery("select",a).each((function(){var e="waymark-dropdown-"+jQuery(this).data("id")+"-";e+=jQuery(this).val(),a.addClass(e),jQuery(this).on("change",(function(){var e="waymark-dropdown-"+jQuery(this).data("id")+"-";jQuery("option",jQuery(this)).each((function(){a.removeClass(e+jQuery(this).attr("value"))})),e+=jQuery(this).val(),a.addClass(e)}))}))}))}function waymark_setup_map_query(){var a=1;jQuery(".waymark-query-form.waymark-map-query .waymark-parameters-container").each((function(){jQuery(this).css("background","red"),jQuery(this).attr("data-index",a);var e=jQuery(".waymark-input",jQuery(this));e.each((function(){jQuery(this).on("change",(function(){waymark_execute_query(jQuery(this).parents(".waymark-parameters-container"))}))})),e.last().trigger("change"),jQuery(this).hover((function(){waymark_render_map_query(jQuery(this))}),(function(){waymark_unrender_map_query(jQuery(this))})),a++}))}function waymark_setup_tax_query(){jQuery("body.taxonomy-waymark_query .waymark-query-form.waymark-tax-query").each((function(){var a=jQuery(this);jQuery(".waymark-parameters-container .waymark-input",a).each((function(){jQuery(this).change((function(){waymark_execute_query(jQuery(this).parents(".waymark-parameters-container"))}))})),jQuery(".waymark-input",a).first().trigger("change")}));var a=jQuery(".postbox#tax_queries_content");if(a.length){jQuery(".waymark-input-query_area_bounds",a).each((function(){var a=jQuery("#waymark-parameters-waymark_map .waymark-input-query_area").first();(query_area_string=a.val())&&jQuery(this).val(query_area_string),waymark_execute_query(jQuery(this).parents(".waymark-parameters-container"))}));var e=jQuery("body.post-type-waymark_map #tagsdiv-waymark_query");if(e.length){var r=jQuery("<select />").addClass("waymark-input").append(jQuery("<option />").attr("value","bounds").text("Bounds"));e.append(r);var t=jQuery("<button />").html('<i class="ion-edit"></i>').addClass("waymark-input").click("click",(function(a){a.preventDefault();var e=jQuery(".waymark-instance").first().data("Waymark");if(e.is_bounds_editing()){var r=e.bounds_to_string(e.bounds_selector_layer.getBounds());(t=jQuery("#waymark-parameters-waymark_map .waymark-input-query_area").first()).val(r),jQuery(".postbox#tax_queries_content .waymark-input-query_area_bounds").each((function(){jQuery(this).val(r),waymark_execute_query(jQuery(this).parents(".waymark-parameters-container"))})),jQuery(this).html('<i class="ion-edit"></i>'),e.undraw_selectors()}else{jQuery(this).html('<i class="ion-android-done"></i>');var t=jQuery("#waymark-parameters-waymark_map .waymark-input-query_area").first();(query_area_string=t.val())||(query_area_string=e.bounds_to_string(e.get_default_bounds())),e.draw_bounds_selector("bounds",query_area_string),e.edit_bounds_selector()}}));e.append(t)}}}function waymark_execute_query(a){if(!(!a instanceof jQuery)){var e={},r=new FormData;r.append("waymark_security",waymark_admin_js.security),r.append("action","waymark_get_query_data"),(query_index=a.data("index"))&&r.append("query_index",query_index);var t=0;jQuery(".waymark-input",a).each((function(){var a=jQuery(this),n=jQuery(this).val();switch(a.data("id")){case"query_overpass_request":if(!n)return console.log("No Overpass Query"),!1;break;case"query_area_bounds":if(!n)return console.log("No Query Area"),!1}r.append(jQuery(this).data("id"),jQuery(this).val()),t++,e[jQuery(this).data("id")]=jQuery(this).val()})),t&&jQuery.ajax({type:"POST",url:waymark_admin_js.ajaxurl,data:r,dataType:"json",processData:!1,contentType:!1,success:function(a){if(void 0!==a.status)switch(a.status){case"success":if(query_data=JSON.parse(a.query_data)){var e=jQuery(".waymark-instance").first().data("Waymark");query_data.features.length&&((query_index=this.data.get("query_index"))?e.load_query_json(query_data,query_index):e.load_query_json(query_data))}break;case"error":a.message&&alert(a.message)}}})}}function waymark_setup_settings_nav(){var a=jQuery("body.wp-admin.waymark_page_waymark-settings #waymark-settings-nav");if(!a)return!1;var e=jQuery("#waymark-admin-container"),r=jQuery("form",e),t=(jQuery(".waymark-settings-tab",e),a.data("init_tab_key")),n=jQuery("select",a);n.hover((function(){jQuery(this).attr("size",jQuery("option",jQuery(this)).length)}),(function(){jQuery(this).removeAttr("size")})),n.change((function(){n.removeAttr("size");var a=jQuery(this).val();e.attr("class","");var i=jQuery('input[name="_wp_http_referer"]',r),s=document.location.toString();s=s.indexOf("content=")>0?s.replace("content="+t,"content="+a):s+"&content="+a,i.val(s);jQuery("."+a).first();jQuery(".waymark-settings-tab").each((function(){var r=jQuery(this);r.hide(),a.indexOf("settings-tab")&&r.hasClass(a)&&(r.show(),e.addClass("waymark-active-"+a)),jQuery(".waymark-settings-section",r).each((function(){var t=jQuery(this);a.indexOf("settings-tab")>0?t.show():a.indexOf("settings-section")>0&&(t.hide(),t.hasClass(a)&&(r.show(),t.show(),e.addClass("waymark-active-"+a)))}))}))})),n.trigger("change")}function waymark_render_map_query(a=!1){if(!(!a instanceof jQuery)){var e=jQuery(".waymark-instance").first().data("Waymark");if(!e.is_bounds_editing()){a.addClass("waymark-active");var r=jQuery(".waymark-input-query_area_type",a).first().val(),t=jQuery(".waymark-input-query_area_bounds",a).first(),n=jQuery(".waymark-input-query_area_polygon",a).first();switch(r){case"bounds":var i=t.val();break;case"polygon":i=n.val()}var s=e.draw_bounds_selector(r,i),u={Waymark:Waymark,area_type:r,area_bounds_input:t,area_polygon_input:n};s.on("editable:vertex:dragend",(function(){switch(this.area_type){case"bounds":var a=s.getBounds();this.area_bounds_input.val(this.Waymark.bounds_to_string(a)),this.area_bounds_input.trigger("change");break;case"polygon":var e=s.getLatLngs();this.area_polygon_input.val(this.Waymark.polygon_array_to_string(e)),this.area_polygon_input.trigger("change")}}),u);var o=jQuery("<button />").html('<i class="ion ion-edit"></i>').addClass("button waymark-edit").on("click",u,(function(a){a.preventDefault(),a.data.Waymark.is_bounds_editing()?(Waymark.unedit_bounds_selector(),jQuery(this).html('<i class="ion ion-edit"></i>')):(Waymark.edit_bounds_selector(),jQuery(this).html('<i class="ion ion-android-done"></i>'))}));a.append(o)}}}function waymark_unrender_map_query(a=!1){if(!(!a instanceof jQuery)){var e=jQuery(".waymark-instance").first().data("Waymark");e.is_bounds_editing()||(jQuery(".waymark-edit",a).remove(),e.undraw_selectors(),a.removeClass("waymark-active"))}}function waymark_handle_repeatable_clone(a){if(!(!a instanceof jQuery)){var e=a.parents(".waymark-form");if(e&&e.hasClass("waymark-map-query")){var r=jQuery(".waymark-instance").first().data("Waymark"),t=r.get_default_bounds();jQuery(".waymark-input-query_area_bounds",a).first().val(r.bounds_to_string(t));var n=jQuery(".waymark-input-query_area_polygon",a).first(),i=Waymark.latlng_bounds_to_latlng_array(t);n.val(r.polygon_array_to_string(i)),a.hover((function(){waymark_render_map_query(jQuery(this))}),(function(){waymark_unrender_map_query(jQuery(this))}))}return a}}function waymark_setup_repeatable_parameters(){jQuery(".waymark-repeatable-container").each((function(){var a=jQuery(this),e=a.data("count"),r=jQuery(".waymark-repeatable-template",a);r.removeClass("waymark-repeatable-template"),r.remove(),jQuery(".waymark-parameters-container",a).each((function(){var a=jQuery(this),e=jQuery("<button />").html('<i class="ion ion-android-delete"></i>').addClass("button waymark-delete").on("click",(function(e){e.preventDefault(),a.remove()}));a.append(e)}));var t=jQuery(".waymark-repeatable-add",a).first();t.on("click",(function(n){n.preventDefault();var i=r.clone();return jQuery(".waymark-input",i).each((function(){var a=jQuery(this);a.attr("name",a.attr("name").replace("__count__",e))})),jQuery(".waymark-control-label",i).each((function(){var a=jQuery(this);a.attr("for",a.attr("for").replace("__count__",e))})),t.before(i),i=waymark_handle_repeatable_clone(i),waymark_setup_dropdowns(),a.data("count",++e),!1}))}))}function waymark_setup_settings_maps(){var a=jQuery("body.wp-admin.waymark_page_waymark-settings #waymark-admin-container form");if(a){var e=jQuery(".map_default_latlng-container .waymark-controls",a).first(),r=jQuery(".waymark-input-map_default_latlng",e).first(),t=jQuery("<button />").html('<i class="ion ion-edit"></i>').addClass("button waymark-edit").on("click",(function(a){a.preventDefault();var e=jQuery("#waymark-map-latlng_selector");e.hasClass("waymark-hidden")?(jQuery(this).html('<i class="ion ion-android-done"></i>'),e.removeClass("waymark-hidden")):(jQuery(this).html('<i class="ion ion-edit"></i>'),e.addClass("waymark-hidden"));var t=e.data("Waymark");return t.map.invalidateSize(),t.draw_latlng_selector(r),!1}));e.append(t);var n=jQuery(".query_area_bounds-container .waymark-controls",a).first(),i=jQuery(".waymark-input-query_area_bounds",n).first();t=jQuery("<button />").html('<i class="ion ion-edit"></i>').addClass("button waymark-edit").on("click",(function(a){a.preventDefault();var e=jQuery("#waymark-map-bounds_selector");e.hasClass("waymark-hidden")?(jQuery(this).html('<i class="ion ion-android-done"></i>'),e.removeClass("waymark-hidden")):(jQuery(this).html('<i class="ion ion-edit"></i>'),e.addClass("waymark-hidden"));var r=e.data("Waymark");return r.map.invalidateSize(),r.draw_bounds_selector("bounds",i.val()),r.edit_bounds_selector(),!1}));n.append(t)}}jQuery(document).ready((function(){waymark_setup_parameter_tooltips(),waymark_setup_map_export(),waymark_setup_accordions()})),jQuery(document).ready((function(){waymark_setup_settings_nav(),waymark_setup_repeatable_settings(),waymark_setup_repeatable_parameters(),waymark_setup_marker_tab(),waymark_setup_settings_maps(),waymark_setup_colour_pickers(),waymark_setup_external_links(),waymark_setup_select_meta_type(),waymark_setup_select_icon_type(),waymark_setup_dropdowns(),waymark_setup_map_query(),waymark_setup_tax_query()}));